x-n8n-common-env: &n8n-common-env
  DB_TYPE: postgresdb
  DB_POSTGRESDB_HOST: ${POSTGRES_HOST}
  DB_POSTGRESDB_PORT: 5432
  DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
  DB_POSTGRESDB_USER: ${POSTGRES_USER}
  DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
  N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
  GENERIC_TIMEZONE: ${GENERIC_TIMEZONE}
  TZ: ${TZ}
  NODE_ENV: ${NODE_ENV}
  N8N_DIAGNOSTICS_ENABLED: ${N8N_DIAGNOSTICS_ENABLED}
  N8N_PERSONALIZATION_ENABLED: ${N8N_PERSONALIZATION_ENABLED}
  EXECUTIONS_MODE: ${EXECUTIONS_MODE}
  QUEUE_BULL_REDIS_HOST: ${QUEUE_BULL_REDIS_HOST}
  QUEUE_BULL_REDIS_PORT: ${QUEUE_BULL_REDIS_PORT}
  QUEUE_BULL_REDIS_PASSWORD: ${QUEUE_BULL_REDIS_PASSWORD}
  N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}

x-n8n-main-env: &n8n-main-env
  <<: *n8n-common-env
  N8N_HOST: ${N8N_HOST}
  N8N_PORT: ${N8N_PORT}
  N8N_PROTOCOL: ${N8N_PROTOCOL}
  WEBHOOK_URL: ${WEBHOOK_URL}
  OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: ${OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS}
  N8N_RUNNERS_ENABLED: "true"
  N8N_RUNNERS_MODE: external
  N8N_TASK_BROKER_ENABLED: "true"
  N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
  N8N_RUNNERS_BROKER_PORT: 5679

x-n8n-worker-env: &n8n-worker-env
  <<: *n8n-common-env
  N8N_RUNNERS_ENABLED: "true"
  N8N_RUNNERS_MODE: external
  N8N_TASK_BROKER_ENABLED: "false"
  N8N_TASK_BROKER_HOST: n8n-main
  N8N_TASK_BROKER_PORT: 5679

services:
  # ----------------------------------------
  # Postgres (Database)
  # ----------------------------------------
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - db_storage:/var/lib/postgresql/data
    networks:
      - n8n_network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
        ]
      interval: 5s
      timeout: 5s
      retries: 10

  # ----------------------------------------
  # Redis (Queue & Cache)
  # ----------------------------------------
  redis:
    image: redis:6-alpine
    restart: always
    command:
      [
        "redis-server",
        "--save",
        "20",
        "1",
        "--loglevel",
        "warning",
        "--requirepass",
        "${REDIS_PASSWORD}",
      ]
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - redis_storage:/data
    networks:
      - n8n_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ----------------------------------------
  # Traefik (Reverse Proxy)
  # ----------------------------------------
  traefik:
    image: "traefik"
    restart: always
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--certificatesresolvers.tlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.tlschallenge.acme.email=${TRAEFIK_ACME_EMAIL}"
      - "--certificatesresolvers.tlschallenge.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - n8n_network

  # ----------------------------------------
  # n8n Main (Orchestrator + Web UI + Task Broker)
  # ----------------------------------------
  n8n-main:
    image: n8nio/n8n:2.1.4
    restart: always
    container_name: n8n-main
    environment: *n8n-main-env
    ports:
      - "127.0.0.1:5678:5678"
    links:
      - postgres
      - redis
    volumes:
      - n8n_storage:/home/node/.n8n
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - n8n_network
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n.rule=Host(`${N8N_HOST}`)
      - traefik.http.routers.n8n.tls=true
      - traefik.http.routers.n8n.entrypoints=web,websecure
      - traefik.http.routers.n8n.tls.certresolver=tlschallenge
      - traefik.http.middlewares.n8n.headers.SSLRedirect=true

  # ----------------------------------------
  # n8n Worker (Workflow Execution Only)
  # ----------------------------------------
  n8n-worker:
    image: n8nio/n8n:2.1.4
    restart: always
    command: worker
    container_name: n8n-worker
    environment: *n8n-worker-env
    links:
      - postgres
      - redis
    volumes:
      - n8n_storage:/home/node/.n8n
    depends_on:
      n8n-main:
        condition: service_started
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - n8n_network

  # ----------------------------------------
  # n8n Runtime (External Task Runners)
  # ----------------------------------------
  n8n-runtime:
    image: n8nio/runners:2.1.4
    restart: always
    container_name: n8n-runtime
    environment:
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_RUNNER_MAX_CONCURRENCY: ${N8N_RUNNER_MAX_CONCURRENCY}
      N8N_TASK_BROKER_HOST: n8n-main
      N8N_TASK_BROKER_PORT: 5679
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
    depends_on:
      n8n-main:
        condition: service_started
    networks:
      - n8n_network

volumes:
  db_storage:
  n8n_storage:
  redis_storage:
  traefik_data:

networks:
  n8n_network:
    driver: bridge
